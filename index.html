<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI So·∫°n K·∫ø Ho·∫°ch B√†i D·∫°y (Th√¥ng t∆∞ 5512)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Th∆∞ vi·ªán c·∫ßn thi·∫øt cho vi·ªác xu·∫•t PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Th∆∞ vi·ªán KaTeX cho hi·ªÉn th·ªã C√¥ng th·ª©c To√°n h·ªçc/Khoa h·ªçc -->
    <!-- KaTeX CSS for styling math formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-FzT4OkkjW4fQ/52y9n1HwJ7E/l4DqD5wTfT/T1nE7o8vO+N8Kj+t4S9Tf/B9QoA==" crossorigin="anonymous">
    <!-- KaTeX JavaScript for rendering math formulas -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-N53v5pG3r/9N/5x5J7O5+J/T5Q4F6/w7R5D2A==" crossorigin="anonymous"></script>
    <!-- Auto-render extension to process delimiters like $...$ and $$...$$ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-uOQz0Q+L8dGv2B3W6l1iE8C7D5Q4p3Ww1D/yW6/z9K5Y8P5+w4z9VQ4F6/w7R5D2A==" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-box {
            background-color: white;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .activity-card {
            border-left: 4px solid #3b82f6;
        }
        /* ·∫®n c√°c n√∫t ƒëi·ªÅu khi·ªÉn khi chu·∫©n b·ªã xu·∫•t PDF */
        @media print {
            .no-print {
                display: none !important;
            }
        }
        /* ƒêi·ªÅu ch·ªânh KaTeX ƒë·ªÉ hi·ªÉn th·ªã t·ªët trong layout */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 8px 0;
        }

        /* B·∫Øt ƒë·∫ßu: ƒêi·ªÅu ch·ªânh c·ª° ch·ªØ cho n·ªôi dung xu·∫•t PDF (13px ~ 13pt) */
        #lesson-plan-output {
            font-size: 13px;
        }
        /* ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ v·∫´n ƒë·ªß l·ªõn */
        #lesson-plan-output h3 {
            font-size: 1.5rem !important; 
        }
        #lesson-plan-output h4 {
            font-size: 1.25rem !important; 
        }
        /* ƒê·∫£m b·∫£o c√°c th√†nh ph·∫ßn nh·ªè h∆°n c≈©ng l√† 13px */
        #lesson-plan-output p, 
        #lesson-plan-output ul li, 
        #lesson-plan-output .activity-card div {
            font-size: 13px !important;
            line-height: 1.6;
        }
        /* K·∫øt th√∫c: ƒêi·ªÅu ch·ªânh c·ª° ch·ªØ cho n·ªôi dung xu·∫•t PDF */
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 mb-6 text-center">
            <span class="inline-block align-middle mr-2">
                <!-- Icon for Lesson Plan -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-pen"><path d="M15 10l.9 3c.6 2 2 3.5 4.5 4.5"/><path d="M12 20h-7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v7.5"/><path d="M22 13.5V17l-3.5-3.5L19 12l2.5 1.5Z"/></svg>
            </span>
            AI So·∫°n K·∫ø Ho·∫°ch B√†i D·∫°y (Th√¥ng t∆∞ 5512)
        </h1>
        <p class="text-center text-gray-600 mb-8">Tr·ª£ l√Ω ·∫£o gi√∫p gi√°o vi√™n c√°c c·∫•p t·∫°o gi√°o √°n theo ƒë·ªãnh h∆∞·ªõng ph√°t tri·ªÉn nƒÉng l·ª±c h·ªçc sinh.</p>

        <!-- Input Form -->
        <div id="input-form" class="container-box p-6 md:p-8 rounded-xl transition-all duration-300 no-print">
            <h2 class="2xl font-semibold text-gray-800 mb-6">Th√¥ng Tin B√†i H·ªçc</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- M√¥n h·ªçc - D√πng Select -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">M√¥n h·ªçc:</label>
                    <select id="subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="To√°n">To√°n</option>
                        <option value="Ng·ªØ VƒÉn">Ng·ªØ VƒÉn</option>
                        <option value="V·∫≠t l√Ω" selected>V·∫≠t l√Ω</option>
                        <option value="H√≥a h·ªçc">H√≥a h·ªçc</option>
                        <option value="Sinh h·ªçc">Sinh h·ªçc</option>
                        <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option>
                        <option value="ƒê·ªãa l√Ω">ƒê·ªãa l√Ω</option>
                        <option value="Gi√°o d·ª•c C√¥ng d√¢n">Gi√°o d·ª•c C√¥ng d√¢n</option>
                        <option value="Tin h·ªçc">Tin h·ªçc</option>
                        <option value="Ti·∫øng Anh">Ti·∫øng Anh</option>
                        <option value="Kh√°c">Kh√°c...</option>
                    </select>
                </div>
                
                <!-- Kh·ªëi/C·∫•p h·ªçc - D√πng Select -->
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Kh·ªëi/C·∫•p h·ªçc:</label>
                    <select id="grade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="Ti·ªÉu h·ªçc (C·∫•p 1)">Ti·ªÉu h·ªçc (C·∫•p 1)</option>
                        <option value="THCS (C·∫•p 2)">THCS (C·∫•p 2)</option>
                        <option value="THPT (C·∫•p 3)">THPT (C·∫•p 3)</option>
                        <option value="L·ªõp 6">L·ªõp 6</option>
                        <option value="L·ªõp 7">L·ªõp 7</option>
                        <option value="L·ªõp 8">L·ªõp 8</option>
                        <option value="L·ªõp 9">L·ªõp 9</option>
                        <option value="L·ªõp 10" selected>L·ªõp 10</option>
                        <option value="L·ªõp 11">L·ªõp 11</option>
                        <option value="L·ªõp 12">L·ªõp 12</option>
                    </select>
                </div>
                
                <!-- T√™n b√†i h·ªçc - Gi·ªØ nguy√™n Input -->
                <div>
                    <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªß ƒë·ªÅ/T√™n b√†i h·ªçc:</label>
                    <input type="text" id="topic" value="ƒê·ªãnh lu·∫≠t II Newton: C√¥ng th·ª©c $F = ma$ v√† ·ª©ng d·ª•ng" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: ƒê·ªãnh l√Ω Py-ta-go, Chi·∫øn tranh th·∫ø gi·ªõi th·ª© nh·∫•t">
                </div>
                
                <!-- T·ªânh/Th√†nh ph·ªë c√¥ng t√°c - D√πng Select (C·∫≠p nh·∫≠t danh s√°ch 63 t·ªânh/th√†nh) -->
                <div>
                    <label for="province" class="block text-sm font-medium text-gray-700 mb-1">T·ªânh/Th√†nh ph·ªë c√¥ng t√°c:</label>
                    <select id="province" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <!-- 5 Th√†nh ph·ªë tr·ª±c thu·ªôc Trung ∆∞∆°ng (∆Øu ti√™n) -->
                        <option value="H√† N·ªôi">H√† N·ªôi</option>
                        <option value="TP. H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
                        <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                        <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                        <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                        <!-- 58 T·ªânh c√≤n l·∫°i -->
                        <option value="An Giang">An Giang</option>
                        <option value="B√† R·ªãa - V≈©ng T√†u">B√† R·ªãa - V≈©ng T√†u</option>
                        <option value="B·∫Øc Giang">B·∫Øc Giang</option>
                        <option value="B·∫Øc K·∫°n">B·∫Øc K·∫°n</option>
                        <option value="B·∫°c Li√™u">B·∫°c Li√™u</option>
                        <option value="B·∫Øc Ninh">B·∫Øc Ninh</option>
                        <option value="B·∫øn Tre">B·∫øn Tre</option>
                        <option value="B√¨nh ƒê·ªãnh">B√¨nh ƒê·ªãnh</option>
                        <option value="B√¨nh D∆∞∆°ng">B√¨nh D∆∞∆°ng</option>
                        <option value="B√¨nh Ph∆∞·ªõc">B√¨nh Ph∆∞·ªõc</option>
                        <option value="B√¨nh Thu·∫≠n">B√¨nh Thu·∫≠n</option>
                        <option value="C√† Mau">C√† Mau</option>
                        <option value="Cao B·∫±ng">Cao B·∫±ng</option>
                        <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
                        <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
                        <option value="ƒêi·ªán Bi√™n">ƒêi·ªán Bi√™n</option>
                        <option value="ƒê·ªìng Nai">ƒê·ªìng Nai</option>
                        <option value="ƒê·ªìng Th√°p">ƒê·ªìng Th√°p</option>
                        <option value="Gia Lai">Gia Lai</option>
                        <option value="H√† Giang">H√† Giang</option>
                        <option value="H√† Nam">H√† Nam</option>
                        <option value="H√† Tƒ©nh">H√† Tƒ©nh</option>
                        <option value="H·∫£i D∆∞∆°ng">H·∫£i D∆∞∆°ng</option>
                        <option value="H·∫≠u Giang">H·∫≠u Giang</option>
                        <option value="H√≤a B√¨nh">H√≤a B√¨nh</option>
                        <option value="H∆∞ng Y√™n">H∆∞ng Y√™n</option>
                        <option value="Kh√°nh H√≤a">Kh√°nh H√≤a</option>
                        <option value="Ki√™n Giang" selected>Ki√™n Giang</option>
                        <option value="Kon Tum">Kon Tum</option>
                        <option value="Lai Ch√¢u">Lai Ch√¢u</option>
                        <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                        <option value="L·∫°ng S∆°n">L·∫°ng S∆°n</option>
                        <option value="L√†o Cai">L√†o Cai</option>
                        <option value="Long An">Long An</option>
                        <option value="Nam ƒê·ªãnh">Nam ƒê·ªãnh</option>
                        <option value="Ngh·ªá An">Ngh·ªá An</option>
                        <option value="Ninh B√¨nh">Ninh B√¨nh</option>
                        <option value="Ninh Thu·∫≠n">Ninh Thu·∫≠n</option>
                        <option value="Ph√∫ Th·ªç">Ph√∫ Th·ªç</option>
                        <option value="Ph√∫ Y√™n">Ph√∫ Y√™n</option>
                        <option value="Qu·∫£ng B√¨nh">Qu·∫£ng B√¨nh</option>
                        <option value="Qu·∫£ng Nam">Qu·∫£ng Nam</option>
                        <option value="Qu·∫£ng Ng√£i">Qu·∫£ng Ng√£i</option>
                        <option value="Qu·∫£ng Ninh">Qu·∫£ng Ninh</option>
                        <option value="Qu·∫£ng Tr·ªã">Qu·∫£ng Tr·ªã</option>
                        <option value="S√≥c TrƒÉng">S√≥c TrƒÉng</option>
                        <option value="S∆°n La">S∆°n La</option>
                        <option value="T√¢y Ninh">T√¢y Ninh</option>
                        <option value="Th√°i B√¨nh">Th√°i B√¨nh</option>
                        <option value="Th√°i Nguy√™n">Th√°i Nguy√™n</option>
                        <option value="Thanh H√≥a">Thanh H√≥a</option>
                        <option value="Th·ª´a Thi√™n Hu·∫ø">Th·ª´a Thi√™n Hu·∫ø</option>
                        <option value="Ti·ªÅn Giang">Ti·ªÅn Giang</option>
                        <option value="Tr√† Vinh">Tr√† Vinh</option>
                        <option value="Tuy√™n Quang">Tuy√™n Quang</option>
                        <option value="Vƒ©nh Long">Vƒ©nh Long</option>
                        <option value="Vƒ©nh Ph√∫c">Vƒ©nh Ph√∫c</option>
                        <option value="Y√™n B√°i">Y√™n B√°i</option>
                    </select>
                </div>
                
                <!-- Th·ªùi l∆∞·ª£ng - Gi·ªØ nguy√™n Input -->
                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi l∆∞·ª£ng (S·ªë ti·∫øt):</label>
                    <input type="text" id="duration" value="2 Ti·∫øt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: 2 ti·∫øt, 90 ph√∫t">
                </div>
            </div>

            <button id="generate-btn" onclick="generateLessonPlan()" class="mt-8 w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center">
                <span id="btn-text">T·∫°o K·∫ø Ho·∫°ch B√†i D·∫°y</span>
                <span id="loading-spinner" class="hidden ml-2">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>

        <!-- Output Display -->
        <div id="output-section" class="mt-10 hidden">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-blue-600 pb-2 mb-6">K·∫æ HO·∫†CH B√ÄI D·∫†Y (D·ª± Th·∫£o AI)</h2>
            <div id="lesson-plan-output" class="container-box p-6 md:p-10 rounded-xl">
                <!-- Content will be injected here -->
            </div>
            
            <!-- N√∫t T·∫£i Xu·ªëng PDF -->
            <div class="mt-6 flex justify-center no-print">
                <button id="pdf-download-btn" onclick="exportToPdf()" class="px-8 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-300 flex items-center justify-center disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-2 mr-2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    T·∫£i Xu·ªëng PDF
                </button>
            </div>
            <!-- K·∫øt th√∫c N√∫t T·∫£i Xu·ªëng PDF -->
            
            <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">L·ªói:</strong>
                <span id="error-text" class="block sm:inline">Kh√¥ng th·ªÉ t·∫°o gi√°o √°n. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi.</span>
            </div>
        </div>

        <!-- Utility Functions and AI Logic -->
        <script>
            // --- FIREBASE AND ENVIRONMENT SETUP ---
            // L∆ØU √ù QUAN TR·ªåNG: B·∫°n c·∫ßn D√ÅN KH√ìA API Gemini c·ªßa m√¨nh v√†o ƒë√¢y ƒë·ªÉ ·ª©ng d·ª•ng ch·∫°y tr√™n GitHub Pages
            const apiKey = "AIzaSyA2zWfhpxrRhH_Pb0Y2t3TcmzO8euqOLnw"; // <<< THAY TH·∫æ CHU·ªñI N√ÄY B·∫∞NG KH√ìA API C·ª¶A B·∫†N
            
            // NOTE: C√ÅC BI·∫æN M√îI TR∆Ø·ªúNG __app_id, __firebase_config, __initial_auth_token ƒë∆∞·ª£c lo·∫°i b·ªè 
            // kh·ªèi ph·∫ßn khai b√°o 'const' ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi script kh√¥ng d√πng 'module' (gi·∫£i quy·∫øt l·ªói b·∫•m n√∫t).
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            

            // --- UI Elements ---
            const generateBtn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const outputSection = document.getElementById('output-section');
            const lessonPlanOutput = document.getElementById('lesson-plan-output');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const pdfDownloadBtn = document.getElementById('pdf-download-btn'); // N√∫t m·ªõi

            // Kh·ªüi t·∫°o n√∫t PDF b·ªã v√¥ hi·ªáu h√≥a
            pdfDownloadBtn.disabled = true;
            
            // --- GEMINI API Configuration (Same as before) ---

            const LESSON_PLAN_SCHEMA = {
                type: "OBJECT",
                properties: {
                    tenBaiHoc: { type: "STRING", description: "T√™n b√†i h·ªçc ho·∫∑c ch·ªß ƒë·ªÅ" },
                    thoiLuong: { type: "STRING", description: "Th·ªùi l∆∞·ª£ng d·ª± ki·∫øn" },
                    mucTieu: {
                        type: "OBJECT",
                        properties: {
                            kienThuc: { type: "STRING", description: "M·ª•c ti√™u v·ªÅ ki·∫øn th·ª©c" },
                            nangLuc: { type: "STRING", description: "M·ª•c ti√™u v·ªÅ nƒÉng l·ª±c (chung v√† ƒë·∫∑c th√π)" },
                            phamChat: { type: "STRING", description: "M·ª•c ti√™u v·ªÅ ph·∫©m ch·∫•t (chƒÉm ch·ªâ, tr√°ch nhi·ªám, trung th·ª±c...)" }
                        },
                        propertyOrdering: ["kienThuc", "nangLuc", "phamChat"]
                    },
                    thietBiDayHocVaHocLieu: { type: "STRING", description: "Thi·∫øt b·ªã d·∫°y h·ªçc v√† h·ªçc li·ªáu c·∫ßn chu·∫©n b·ªã (VD: m√°y chi·∫øu, phi·∫øu h·ªçc t·∫≠p, video)" },
                    tienTrinhDayHoc: {
                        type: "ARRAY",
                        description: "Ti·∫øn tr√¨nh d·∫°y h·ªçc chi ti·∫øt theo c√°c b∆∞·ªõc (Kh·ªüi ƒë·ªông, H√¨nh th√†nh Ki·∫øn th·ª©c, Luy·ªán t·∫≠p, V·∫≠n d·ª•ng)",
                        items: {
                            type: "OBJECT",
                            properties: {
                                tenHoatDong: { type: "STRING", description: "T√™n ho·∫°t ƒë·ªông (VD: Kh·ªüi ƒë·ªông, Kh√°m ph√° Ki·∫øn th·ª©c, Th·ª±c h√†nh/Luy·ªán t·∫≠p, V·∫≠n d·ª•ng/M·ªü r·ªông)" },
                                thoiGian: { type: "STRING", description: "Th·ªùi gian d·ª± ki·∫øn cho ho·∫°t ƒë·ªông n√†y" },
                                noiDungVaCachThuc: { type: "STRING", description: "N·ªôi dung, ph∆∞∆°ng ph√°p v√† h√¨nh th·ª©c t·ªï ch·ª©c ho·∫°t ƒë·ªông" },
                                sanPham: { type: "STRING", description: "S·∫£n ph·∫©m h·ªçc t·∫≠p d·ª± ki·∫øn (VD: C√¢u tr·∫£ l·ªùi c·ªßa HS, s∆° ƒë·ªì t∆∞ duy, b√†i thuy·∫øt tr√¨nh)" }
                            },
                            propertyOrdering: ["tenHoatDong", "thoiGian", "noiDungVaCachThuc", "sanPham"]
                        }
                    },
                    danhGia: { type: "STRING", description: "H√¨nh th·ª©c ƒë√°nh gi√° t·ªïng th·ªÉ (VD: Quan s√°t, b√†i ki·ªÉm tra nhanh, s·∫£n ph·∫©m d·ª± √°n nh·ªè)" }
                },
                propertyOrdering: ["tenBaiHoc", "thoiLuong", "mucTieu", "thietBiDayHocVaHocLieu", "tienTrinhDayHoc", "danhGia"]
            };

            const SYSTEM_INSTRUCTION = `B·∫°n l√† m·ªôt tr·ª£ l√Ω AI chuy√™n nghi·ªáp trong vi·ªác so·∫°n th·∫£o K·∫ø ho·∫°ch B√†i D·∫°y (Gi√°o √°n) theo ƒë·ªãnh h∆∞·ªõng ph√°t tri·ªÉn nƒÉng l·ª±c h·ªçc sinh, tu√¢n th·ªß c√°c nguy√™n t·∫Øc c·ªßa Th√¥ng t∆∞ 5512 (v·ªÅ c·∫•u tr√∫c b√†i d·∫°y hi·ªán ƒë·∫°i: M·ª•c ti√™u, Chu·∫©n b·ªã, Ti·∫øn tr√¨nh D·∫°y h·ªçc, v√† ƒê√°nh gi√°). T·∫°o n·ªôi dung b√†i d·∫°y d∆∞·ªõi d·∫°ng JSON d·ª±a tr√™n ƒë·∫ßu v√†o c·ªßa ng∆∞·ªùi d√πng. H√£y ƒë·∫£m b·∫£o n·ªôi dung chi ti·∫øt, s√°ng t·∫°o, th·ª±c t·∫ø cho gi√°o vi√™n Vi·ªát Nam v√† ph√π h·ª£p v·ªõi m√¥n h·ªçc, c·∫•p h·ªçc ƒë∆∞·ª£c cung c·∫•p. B√†i gi·∫£ng c√≥ t√≠ch h·ª£p c√°c n·ªôi dung nh∆∞ gi√°o d·ª•c ƒë·ªãa ph∆∞∆°ng, STEM (n·∫øu c√≥). Tuy·ªát ƒë·ªëi ch·ªâ ph·∫£n h·ªìi b·∫±ng c·∫•u tr√∫c JSON ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.
                    Ph·∫ßn 1: Vai tr√≤ v√† Nhi·ªám v·ª• (Role and Goal)
[Vai tr√≤] B·∫°n l√† m·ªôt Tr·ª£ l√Ω S∆∞ ph·∫°m Chuy√™n s√¢u v·ªÅ x√¢y d·ª±ng K·∫ø ho·∫°ch B√†i d·∫°y (Gi√°o √°n) theo chu·∫©n B·ªô Gi√°o d·ª•c v√† ƒê√†o t·∫°o, ƒë·∫∑c bi·ªát l√† c·∫•p Trung h·ªçc C∆° s·ªü (THCS).

[M·ª•c ti√™u] Nhi·ªám v·ª• c·ªßa b·∫°n l√† vi·∫øt, ki·ªÉm tra, v√† ho√†n thi·ªán K·∫ø ho·∫°ch B√†i d·∫°y (KBD) cho gi√°o vi√™n THCS theo ƒë√∫ng y√™u c·∫ßu v·ªÅ n·ªôi dung v√† h√¨nh th·ª©c c·ªßa C√¥ng vƒÉn 5112/BGDƒêT-GDTrH ng√†y 01/12/2020, ƒë·∫£m b·∫£o t√≠nh khoa h·ªçc, s∆∞ ph·∫°m v√† ph√π h·ª£p v·ªõi th·ª±c ti·ªÖn.

[Nguy√™n t·∫Øc l√†m vi·ªác] Lu√¥n ƒë·∫∑t m·ª•c ti√™u ph√°t tri·ªÉn ph·∫©m ch·∫•t v√† nƒÉng l·ª±c h·ªçc sinh l√†m tr·ªçng t√¢m.

Ph·∫ßn 2: Y√™u c·∫ßu v·ªÅ N·ªôi dung v√† C·∫•u tr√∫c KBD (Content and Structure Requirements)
[C·∫•u tr√∫c KBD] K·∫ø ho·∫°ch B√†i d·∫°y b·∫°n t·∫°o ra ph·∫£i tu√¢n th·ªß c·∫•u tr√∫c c·ªßa m·ªôt KBD ƒë·∫ßy ƒë·ªß theo y√™u c·∫ßu m·ªõi, bao g·ªìm c√°c th√†nh ph·∫ßn sau:

T√™n B√†i d·∫°y/Ch·ªß ƒë·ªÅ: (V√≠ d·ª•: B√†i 1. S·ªë h·ªØu t·ªâ - To√°n 7)

Th·ªùi l∆∞·ª£ng: (S·ªë ti·∫øt, ng√†y/bu·ªïi th·ª±c hi·ªán)

M·ª•c ti√™u B√†i h·ªçc: Ph√¢n chia r√µ r√†ng th√†nh:

Ki·∫øn th·ª©c: (H·ªçc sinh l√†m ƒë∆∞·ª£c g√¨ sau b√†i h·ªçc)

NƒÉng l·ª±c:

NƒÉng l·ª±c ƒë·∫∑c th√π: (V√≠ d·ª•: NƒÉng l·ª±c t√≠nh to√°n, nƒÉng l·ª±c ng√¥n ng·ªØ, nƒÉng l·ª±c gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ...)

NƒÉng l·ª±c chung: (T·ª± ch·ªß v√† t·ª± h·ªçc, Giao ti·∫øp v√† h·ª£p t√°c, Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v√† s√°ng t·∫°o)

Ph·∫©m ch·∫•t: (V√≠ d·ª•: ChƒÉm ch·ªâ, Trung th·ª±c, Tr√°ch nhi·ªám...)

Thi·∫øt b·ªã d·∫°y h·ªçc v√† H·ªçc li·ªáu: (Li·ªát k√™ chi ti·∫øt)

Ti·∫øn tr√¨nh D·∫°y h·ªçc: (Chia th√†nh c√°c ho·∫°t ƒë·ªông r√µ r√†ng)

Ho·∫°t ƒë·ªông 1: M·ªü ƒë·∫ßu/Kh·ªüi ƒë·ªông (X√°c ƒë·ªãnh v·∫•n ƒë·ªÅ/nhi·ªám v·ª• h·ªçc t·∫≠p, t·∫°o h·ª©ng th√∫)

Ho·∫°t ƒë·ªông 2: H√¨nh th√†nh Ki·∫øn th·ª©c m·ªõi/Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ (T·ªï ch·ª©c Hƒê c·ªßa GV v√† HS)

Ho·∫°t ƒë·ªông 3: Luy·ªán t·∫≠p/Th·ª±c h√†nh (C·ªßng c·ªë ki·∫øn th·ª©c, kƒ© nƒÉng)

Ho·∫°t ƒë·ªông 4: V·∫≠n d·ª•ng/T√¨m t√≤i m·ªü r·ªông (Giao nhi·ªám v·ª• v·ªÅ nh√†, li√™n h·ªá th·ª±c ti·ªÖn)

[Chi ti·∫øt Ti·∫øn tr√¨nh D·∫°y h·ªçc] Trong m·ª•c Ti·∫øn tr√¨nh D·∫°y h·ªçc, m·ªói Ho·∫°t ƒë·ªông ph·∫£i ƒë∆∞·ª£c tr√¨nh b√†y d∆∞·ªõi d·∫°ng m·ªôt b·∫£ng ho·∫∑c list v·ªõi ƒë·∫ßy ƒë·ªß c√°c c·ªôt/m·ª•c: M·ª•c ti√™u, N·ªôi dung (c√¥ng vi·ªác c·ª• th·ªÉ c·ªßa HS), S·∫£n ph·∫©m (d·ª± ki·∫øn), T·ªï ch·ª©c th·ª±c hi·ªán (chi ti·∫øt ho·∫°t ƒë·ªông c·ªßa GV v√† HS).

Ph·∫ßn 3: Quy tr√¨nh T∆∞∆°ng t√°c (Interaction Protocol)
Ch√†o h·ªèi & Thu th·∫≠p th√¥ng tin: Khi b·∫Øt ƒë·∫ßu, b·∫°n h√£y h·ªèi gi√°o vi√™n c√°c th√¥ng tin c·ªët l√µi sau:

M√¥n h·ªçc:

L·ªõp:

T√™n B√†i d·∫°y/Ch·ªß ƒë·ªÅ:

Th·ªùi l∆∞·ª£ng (s·ªë ti·∫øt):

X√¢y d·ª±ng KBD (L∆∞·ª£t 1): D·ª±a tr√™n th√¥ng tin ƒë√£ nh·∫≠n, b·∫°n h√£y ph√°c th·∫£o nhanh M·ª•c ti√™u B√†i h·ªçc v√† ƒë·ªÅ xu·∫•t Ti·∫øn tr√¨nh D·∫°y h·ªçc g·ªìm 4 Ho·∫°t ƒë·ªông c∆° b·∫£n.

Ph·∫£n h·ªìi & Tinh ch·ªânh (L∆∞·ª£t 2+): Sau khi gi√°o vi√™n cung c·∫•p th√™m th√¥ng tin chi ti·∫øt (v√≠ d·ª•: ph∆∞∆°ng ph√°p d·∫°y h·ªçc c·ª• th·ªÉ, t√†i nguy√™n s·ª≠ d·ª•ng, ho·∫∑c mu·ªën ƒëi·ªÅu ch·ªânh ho·∫°t ƒë·ªông n√†o ƒë√≥), b·∫°n ph·∫£i tinh ch·ªânh l·∫°i KBD ƒë·ªÉ ƒë·∫°t ƒë·ªô chi ti·∫øt cao nh·∫•t.

Ki·ªÉm tra C√¥ng vƒÉn 5112: Cu·ªëi c√πng, khi KBD ƒë√£ ho√†n th√†nh, h√£y ƒë∆∞a ra m·ªôt ƒë√°nh gi√° ng·∫Øn g·ªçn v·ªÅ vi·ªác KBD n√†y ƒë√£ ƒë√°p ·ª©ng ƒë·∫ßy ƒë·ªß c√°c y√™u c·∫ßu c∆° b·∫£n c·ªßa C√¥ng vƒÉn 5112 hay ch∆∞a (ƒë·∫∑c bi·ªát l√† vi·ªác chuy·ªÉn t·ª´ "Gi√°o √°n truy·ªÅn th·ªëng" sang "K·∫ø ho·∫°ch B√†i d·∫°y ph√°t tri·ªÉn nƒÉng l·ª±c").

Ph·∫ßn 4: L·ªùi Kh·∫≥ng ƒë·ªãnh (Affirmation)
H√£y nh·ªõ: M·ªçi KBD ƒë·ªÅu ph·∫£i ƒë∆∞·ª£c tr√¨nh b√†y m·ªôt c√°ch s·∫°ch s·∫Ω, logic, d·ªÖ ƒë·ªçc v√† c√≥ th·ªÉ sao ch√©p tr·ª±c ti·∫øp ƒë·ªÉ s·ª≠ d·ª•ng. B·∫Øt ƒë·∫ßu b·∫±ng vi·ªác gi·ªõi thi·ªáu b·∫£n th√¢n v√† h·ªèi th√¥ng tin c·∫ßn thi·∫øt.`;
            // --- Helper Functions ---

            function showLoading(isLoading) {
                generateBtn.disabled = isLoading;
                if (isLoading) {
                    btnText.textContent = 'ƒêang T·∫°o...';
                    loadingSpinner.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    outputSection.classList.add('hidden');
                    pdfDownloadBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t PDF khi ƒëang t·∫°o
                } else {
                    btnText.textContent = 'T·∫°o K·∫ø Ho·∫°ch B√†i D·∫°y';
                    loadingSpinner.classList.add('hidden');
                }
            }

            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                outputSection.classList.add('hidden');
                pdfDownloadBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t PDF khi c√≥ l·ªói
            }

            function generatePrompt(subject, grade, topic, duration, province) {
                // Nh·∫Øc nh·ªü AI s·ª≠ d·ª•ng syntax LaTeX ($...$ v√† $$...$$) cho c√¥ng th·ª©c To√°n/L√Ω/H√≥a
                return `H√£y so·∫°n th·∫£o K·∫ø ho·∫°ch B√†i D·∫°y (Gi√°o √°n) cho m√¥n ${subject}, c·∫•p h·ªçc ${grade}, v·ªõi ch·ªß ƒë·ªÅ/b√†i h·ªçc l√† "${topic}". Th·ªùi l∆∞·ª£ng d·ª± ki·∫øn l√† ${duration}. B√†i gi·∫£ng c·∫ßn t√≠ch h·ª£p n·ªôi dung gi√°o d·ª•c ƒë·ªãa ph∆∞∆°ng ph√π h·ª£p v·ªõi t·ªânh/th√†nh ph·ªë: ${province}. H√£y ƒë·∫£m b·∫£o k·∫ø ho·∫°ch chi ti·∫øt, c√≥ c√°c b∆∞·ªõc Kh·ªüi ƒë·ªông, H√¨nh th√†nh Ki·∫øn th·ª©c, Luy·ªán t·∫≠p, V·∫≠n d·ª•ng v√† th·ªÉ hi·ªán r√µ c√°c m·ª•c ti√™u v·ªÅ Ki·∫øn th·ª©c, NƒÉng l·ª±c, Ph·∫©m ch·∫•t. Khi t·∫°o c√¥ng th·ª©c to√°n h·ªçc ho·∫∑c khoa h·ªçc, h√£y s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng LaTeX (v√≠ d·ª•: $$F = ma$$).`;
            }

            function formatLessonPlan(plan) {
                let html = `<h3 class="text-xl md:text-2xl font-bold text-center text-blue-800 mb-8">${plan.tenBaiHoc.toUpperCase()}</h3>`;
                html += `<div class="space-y-6">`;
                
                // Th·ªùi l∆∞·ª£ng
                html += `<div class="p-4 bg-gray-50 rounded-lg">
                            <p class="font-semibold text-gray-700">‚è∞ Th·ªùi L∆∞·ª£ng:</p>
                            <p class="ml-4 text-lg text-gray-800">${plan.thoiLuong}</p>
                        </div>`;

                // M·ª•c Ti√™u
                html += `<div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <h4 class="text-xl font-bold text-blue-700 mb-2">I. M·ª§C TI√äU</h4>
                            <ul class="list-disc ml-6 space-y-2 text-gray-700">
                                <li><strong class="text-blue-600">Ki·∫øn Th·ª©c:</strong> ${plan.mucTieu.kienThuc}</li>
                                <li><strong class="text-blue-600">NƒÉng L·ª±c:</strong> ${plan.mucTieu.nangLuc}</li>
                                <li><strong class="text-blue-600">Ph·∫©m Ch·∫•t:</strong> ${plan.mucTieu.phamChat}</li>
                            </ul>
                        </div>`;

                // Chu·∫©n b·ªã
                html += `<div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                            <h4 class="text-xl font-bold text-green-700 mb-2">II. THI·∫æT B·ªä D·∫†Y H·ªåC V√Ä H·ªåC LI·ªÜU</h4>
                            <p class="ml-2 text-gray-700">${plan.thietBiDayHocVaHocLieu}</p>
                        </div>`;

                // Ti·∫øn Tr√¨nh D·∫°y H·ªçc
                html += `<div class="mt-8">
                            <h4 class="text-xl font-bold text-gray-800 mb-4">III. TI·∫æN TR√åNH D·∫†Y H·ªåC</h4>
                            <div class="space-y-6">`;

                plan.tienTrinhDayHoc.forEach((activity, index) => {
                    const stepNumber = index + 1;
                    html += `<div class="p-4 activity-card bg-white rounded-lg shadow-md hover:shadow-lg transition duration-200">
                                <p class="text-lg font-bold text-blue-600 mb-2">Ho·∫°t ƒë·ªông ${stepNumber}: ${activity.tenHoatDong}</p>
                                <div class="space-y-1 text-sm text-gray-700 ml-2">
                                    <p><strong>üïí Th·ªùi gian:</strong> ${activity.thoiGian}</p>
                                    <p><strong>üìù N·ªôi dung & C√°ch th·ª©c:</strong> ${activity.noiDungVaCachThuc}</p>
                                    <p><strong>‚úÖ S·∫£n ph·∫©m d·ª± ki·∫øn:</strong> ${activity.sanPham}</p>
                                </div>
                            </div>`;
                });

                html += `       </div>
                            </div>`;

                // ƒê√°nh Gi√°
                html += `<div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400 mt-8">
                            <h4 class="text-xl font-bold text-yellow-700 mb-2">IV. ƒê√ÅNH GI√Å (Ki·ªÉm tra, ƒê√°nh gi√° t·ªïng th·ªÉ)</h4>
                            <p class="ml-2 text-gray-700">${plan.danhGia}</p>
                        </div>`;


                html += `</div>`; // End space-y-6
                return html;
            }
            
            // --- Math Rendering Function ---
            function renderMath(element) {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(element, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, 
                            {left: '$', right: '$', display: false},  
                        ],
                        throwOnError: false 
                    });
                } else {
                    console.warn("KaTeX auto-render extension is not loaded. Math will not be displayed correctly.");
                }
            }


            // --- Main Generation Function ---

            async function generateLessonPlan() {
                if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || !apiKey) {
                    showError("L·ªói: Kh√≥a API ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng d√°n kh√≥a API Gemini c·ªßa b·∫°n v√†o bi·∫øn 'apiKey' trong m√£ ngu·ªìn.");
                    return;
                }

                const subject = document.getElementById('subject').value.trim();
                const grade = document.getElementById('grade').value.trim();
                const topic = document.getElementById('topic').value.trim();
                const province = document.getElementById('province').value.trim(); 
                const duration = document.getElementById('duration').value.trim();

                if (!subject || !grade || !topic || !duration || !province || subject === 'Kh√°c') { 
                    if (subject === 'Kh√°c') {
                         showError("Vui l√≤ng ch·ªçn M√¥n h·ªçc c·ª• th·ªÉ t·ª´ danh s√°ch, ho·∫∑c thay ƒë·ªïi sang ch·∫ø ƒë·ªô nh·∫≠p li·ªáu th·ªß c√¥ng n·∫øu kh√¥ng c√≥ trong danh s√°ch.");
                    } else {
                         showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin.");
                    }
                    return;
                }

                showLoading(true);
                pdfDownloadBtn.disabled = true; // ƒê·∫£m b·∫£o n√∫t t·∫£i v·ªÅ b·ªã kh√≥a
                lessonPlanOutput.innerHTML = '';
                
                const userQuery = generatePrompt(subject, grade, topic, duration, province);

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: SYSTEM_INSTRUCTION }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: LESSON_PLAN_SCHEMA
                    }
                };
                
                let attempt = 0;
                const maxRetries = 3;

                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            let errorMessageDetail = `L·ªói HTTP: ${response.status}. `;
                            if (errorData.error && errorData.error.message) {
                                errorMessageDetail += `Chi ti·∫øt: ${errorData.error.message}`;
                            } else {
                                errorMessageDetail += "Vui l√≤ng ki·ªÉm tra kh√≥a API v√† gi·ªõi h·∫°n s·ª≠ d·ª•ng.";
                            }
                            throw new Error(errorMessageDetail);
                        }

                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (!jsonText) {
                            throw new Error("Ph·∫£n h·ªìi t·ª´ AI r·ªóng ho·∫∑c kh√¥ng c√≥ c·∫•u tr√∫c JSON.");
                        }

                        const lessonPlanData = JSON.parse(jsonText);
                        
                        // Render the structured plan
                        lessonPlanOutput.innerHTML = formatLessonPlan(lessonPlanData);
                        
                        // B∆Ø·ªöC M·ªöI: G·ªçi h√†m KaTeX ƒë·ªÉ hi·ªÉn th·ªã c√¥ng th·ª©c to√°n h·ªçc
                        renderMath(lessonPlanOutput);
                        
                        outputSection.classList.remove('hidden');
                        pdfDownloadBtn.disabled = false; // B·∫≠t n√∫t t·∫£i v·ªÅ
                        showLoading(false);
                        return;

                    } catch (error) {
                        console.error("L·ªói trong qu√° tr√¨nh t·∫°o gi√°o √°n:", error);
                        attempt++;
                        if (attempt < maxRetries) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            showError(`ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng ho·∫∑c m·∫°ng sau ${maxRetries} l·∫ßn th·ª≠. Chi ti·∫øt: ${error.message}`);
                            showLoading(false);
                            return;
                        }
                    }
                }
            }
            
            // --- PDF Export Function (C·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng pdf.html() cho ph√¢n trang t·ªët h∆°n) ---

            async function exportToPdf() {
                const { jsPDF } = window.jspdf; 
                const element = document.getElementById('lesson-plan-output');
                
                const originalBtnContent = pdfDownloadBtn.innerHTML;
                pdfDownloadBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ƒêang T·∫°o PDF...`;
                pdfDownloadBtn.disabled = true;

                try {
                    const pdf = new jsPDF('p', 'mm', 'a4'); 
                    
                    // S·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c html() ƒë·ªÉ jsPDF x·ª≠ l√Ω lu·ªìng n·ªôi dung v√† ph√¢n trang
                    await pdf.html(element, {
                        callback: function (pdf) {
                            const topic = document.getElementById('topic').value.trim() || 'KeHoachBaiDay';
                            const fileName = `KHBaiDay_${topic.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                            pdf.save(fileName);
                        },
                        // Thi·∫øt l·∫≠p l·ªÅ A4 
                        x: 10, // L·ªÅ tr√°i
                        y: 10, // L·ªÅ tr√™n
                        width: 190, // Chi·ªÅu r·ªông n·ªôi dung (210mm - 20mm l·ªÅ)
                        windowWidth: 794 // Chi·ªÅu r·ªông Canvas render (cho ch·∫•t l∆∞·ª£ng t·ªët tr√™n A4)
                    });

                } catch (error) {
                    console.error("L·ªói khi xu·∫•t PDF:", error);
                    const outputMessage = document.getElementById('lesson-plan-output');
                    outputMessage.innerHTML += `<div class="mt-4 text-red-600 font-semibold">L·ªói xu·∫•t PDF: Vui l√≤ng ki·ªÉm tra console ho·∫∑c th·ª≠ l·∫°i.</div>`;
                } finally {
                    pdfDownloadBtn.innerHTML = originalBtnContent;
                    pdfDownloadBtn.disabled = false;
                }
            }
        </script>
    </div>
</body>
</html>

