<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI So·∫°n K·∫ø Ho·∫°ch B√†i D·∫°y (Th√¥ng t∆∞ 5512)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-box {
            background-color: white;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .activity-card {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 mb-6 text-center">
            <span class="inline-block align-middle mr-2">
                <!-- Icon for Lesson Plan -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-pen"><path d="M15 10l.9 3c.6 2 2 3.5 4.5 4.5"/><path d="M12 20h-7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v7.5"/><path d="M22 13.5V17l-3.5-3.5L19 12l2.5 1.5Z"/></svg>
            </span>
            AI So·∫°n K·∫ø Ho·∫°ch B√†i D·∫°y (Th√¥ng t∆∞ 5512)
        </h1>
        <p class="text-center text-gray-600 mb-8">Tr·ª£ l√Ω ·∫£o gi√∫p gi√°o vi√™n c√°c c·∫•p t·∫°o gi√°o √°n theo ƒë·ªãnh h∆∞·ªõng ph√°t tri·ªÉn nƒÉng l·ª±c h·ªçc sinh.</p>

        <!-- Input Form -->
        <div id="input-form" class="container-box p-6 md:p-8 rounded-xl transition-all duration-300">
            <h2 class="2xl font-semibold text-gray-800 mb-6">Th√¥ng Tin B√†i H·ªçc</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">M√¥n h·ªçc:</label>
                    <input type="text" id="subject" value="Ng·ªØ VƒÉn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: To√°n, Ng·ªØ VƒÉn, L·ªãch S·ª≠">
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Kh·ªëi/C·∫•p h·ªçc:</label>
                    <input type="text" id="grade" value="L·ªõp 11" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: L·ªõp 10, THCS, Ti·ªÉu h·ªçc">
                </div>
                <div>
                    <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªß ƒë·ªÅ/T√™n b√†i h·ªçc:</label>
                    <input type="text" id="topic" value="T√°c ph·∫©m Ch√≠ Ph√®o (Nam Cao)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: ƒê·ªãnh l√Ω Py-ta-go, Chi·∫øn tranh th·∫ø gi·ªõi th·ª© nh·∫•t">
                </div>
                <!-- START: Tr∆∞·ªùng m·ªõi cho T·ªânh/Th√†nh ph·ªë -->
                <div>
                    <label for="province" class="block text-sm font-medium text-gray-700 mb-1">T·ªânh/Th√†nh ph·ªë c√¥ng t√°c:</label>
                    <input type="text" id="province" value="Ki√™n Giang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: H√† N·ªôi, TP.HCM, Ki√™n Giang">
                </div>
                <!-- END: Tr∆∞·ªùng m·ªõi cho T·ªânh/Th√†nh ph·ªë -->
                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi l∆∞·ª£ng (S·ªë ti·∫øt):</label>
                    <input type="text" id="duration" value="3 Ti·∫øt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="V√≠ d·ª•: 2 ti·∫øt, 90 ph√∫t">
                </div>
            </div>

            <button id="generate-btn" onclick="generateLessonPlan()" class="mt-8 w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center">
                <span id="btn-text">T·∫°o K·∫ø Ho·∫°ch B√†i D·∫°y</span>
                <span id="loading-spinner" class="hidden ml-2">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>

        <!-- Output Display -->
        <div id="output-section" class="mt-10 hidden">
            <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-blue-600 pb-2 mb-6">K·∫æ HO·∫†CH B√ÄI D·∫†Y (D·ª± Th·∫£o AI)</h2>
            <div id="lesson-plan-output" class="container-box p-6 md:p-10 rounded-xl">
                <!-- Content will be injected here -->
            </div>
            <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">L·ªói:</strong>
                <span id="error-text" class="block sm:inline">Kh√¥ng th·ªÉ t·∫°o gi√°o √°n. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi.</span>
            </div>
        </div>

        <!-- Utility Functions and AI Logic -->
        <script type="module">
            // --- FIREBASE AND ENVIRONMENT SETUP ---
            // NOTE: B·∫°n c·∫ßn D√ÅN KH√ìA API c·ªßa m√¨nh v√†o ƒë√¢y ƒë·ªÉ ·ª©ng d·ª•ng ch·∫°y tr√™n GitHub Pages
            // (V√≠ d·ª•: const apiKey = "AIzaSy...your...key";)
            const apiKey = "YOUR_GEMINI_API_KEY_HERE"; // <<< THAY TH·∫æ CHU·ªñI N√ÄY B·∫∞NG KH√ìA API C·ª¶A B·∫†N
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            // NOTE: Firestore is not strictly needed for this self-contained generation app, 
            // but the setup variables are required to be present as per instructions.

            // --- UI Elements ---
            const generateBtn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const outputSection = document.getElementById('output-section');
            const lessonPlanOutput = document.getElementById('lesson-plan-output');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            // --- GEMINI API Configuration ---

            // JSON Schema defining the required output structure for the lesson plan
            const LESSON_PLAN_SCHEMA = {
                type: "OBJECT",
                properties: {
                    tenBaiHoc: { type: "STRING", description: "T√™n b√†i h·ªçc ho·∫∑c ch·ªß ƒë·ªÅ" },
                    thoiLuong: { type: "STRING", description: "Th·ªùi l∆∞·ª£ng d·ª± ki·∫øn" },
                    mucTieu: {
                        type: "OBJECT",
                        properties: {
                            kienThuc: { type: "STRING", description: "M·ª•c ti√™u v·ªÅ ki·∫øn th·ª©c" },
                            nangLuc: { type: "STRING", description: "M·ª•c ti√™u v·ªÅ nƒÉng l·ª±c (chung v√† ƒë·∫∑c th√π)" },
                            phamChat: { type: "STRING", description: "M·ª•c ti√™u v·ªÅ ph·∫©m ch·∫•t (chƒÉm ch·ªâ, tr√°ch nhi·ªám, trung th·ª±c...)" }
                        },
                        propertyOrdering: ["kienThuc", "nangLuc", "phamChat"]
                    },
                    thietBiDayHocVaHocLieu: { type: "STRING", description: "Thi·∫øt b·ªã d·∫°y h·ªçc v√† h·ªçc li·ªáu c·∫ßn chu·∫©n b·ªã (VD: m√°y chi·∫øu, phi·∫øu h·ªçc t·∫≠p, video)" },
                    tienTrinhDayHoc: {
                        type: "ARRAY",
                        description: "Ti·∫øn tr√¨nh d·∫°y h·ªçc chi ti·∫øt theo c√°c b∆∞·ªõc (Kh·ªüi ƒë·ªông, H√¨nh th√†nh Ki·∫øn th·ª©c, Luy·ªán t·∫≠p, V·∫≠n d·ª•ng)",
                        items: {
                            type: "OBJECT",
                            properties: {
                                tenHoatDong: { type: "STRING", description: "T√™n ho·∫°t ƒë·ªông (VD: Kh·ªüi ƒë·ªông, Kh√°m ph√° Ki·∫øn th·ª©c, Th·ª±c h√†nh/Luy·ªán t·∫≠p, V·∫≠n d·ª•ng/M·ªü r·ªông)" },
                                thoiGian: { type: "STRING", description: "Th·ªùi gian d·ª± ki·∫øn cho ho·∫°t ƒë·ªông n√†y" },
                                noiDungVaCachThuc: { type: "STRING", description: "N·ªôi dung, ph∆∞∆°ng ph√°p v√† h√¨nh th·ª©c t·ªï ch·ª©c ho·∫°t ƒë·ªông" },
                                sanPham: { type: "STRING", description: "S·∫£n ph·∫©m h·ªçc t·∫≠p d·ª± ki·∫øn (VD: C√¢u tr·∫£ l·ªùi c·ªßa HS, s∆° ƒë·ªì t∆∞ duy, b√†i thuy·∫øt tr√¨nh)" }
                            },
                            propertyOrdering: ["tenHoatDong", "thoiGian", "noiDungVaCachThuc", "sanPham"]
                        }
                    },
                    danhGia: { type: "STRING", description: "H√¨nh th·ª©c ƒë√°nh gi√° t·ªïng th·ªÉ (VD: Quan s√°t, b√†i ki·ªÉm tra nhanh, s·∫£n ph·∫©m d·ª± √°n nh·ªè)" }
                },
                propertyOrdering: ["tenBaiHoc", "thoiLuong", "mucTieu", "thietBiDayHocVaHocLieu", "tienTrinhDayHoc", "danhGia"]
            };

            const SYSTEM_INSTRUCTION = `B·∫°n l√† m·ªôt tr·ª£ l√Ω AI chuy√™n nghi·ªáp trong vi·ªác so·∫°n th·∫£o K·∫ø ho·∫°ch B√†i D·∫°y (Gi√°o √°n) theo ƒë·ªãnh h∆∞·ªõng ph√°t tri·ªÉn nƒÉng l·ª±c h·ªçc sinh, tu√¢n th·ªß c√°c nguy√™n t·∫Øc c·ªßa Th√¥ng t∆∞ 5512 (v·ªÅ c·∫•u tr√∫c b√†i d·∫°y hi·ªán ƒë·∫°i: M·ª•c ti√™u, Chu·∫©n b·ªã, Ti·∫øn tr√¨nh D·∫°y h·ªçc, v√† ƒê√°nh gi√°). T·∫°o n·ªôi dung b√†i d·∫°y d∆∞·ªõi d·∫°ng JSON d·ª±a tr√™n ƒë·∫ßu v√†o c·ªßa ng∆∞·ªùi d√πng. H√£y ƒë·∫£m b·∫£o n·ªôi dung chi ti·∫øt, s√°ng t·∫°o, th·ª±c t·∫ø cho gi√°o vi√™n Vi·ªát Nam v√† ph√π h·ª£p v·ªõi m√¥n h·ªçc, c·∫•p h·ªçc ƒë∆∞·ª£c cung c·∫•p. B√†i gi·∫£ng c√≥ t√≠ch h·ª£p c√°c n·ªôi dung nh∆∞ gi√°o d·ª•c ƒë·ªãa ph∆∞∆°ng, STEM (n·∫øu c√≥). Tuy·ªát ƒë·ªëi ch·ªâ ph·∫£n h·ªìi b·∫±ng c·∫•u tr√∫c JSON ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.
                    Ph·∫ßn 1: Vai tr√≤ v√† Nhi·ªám v·ª• (Role and Goal)
[Vai tr√≤] B·∫°n l√† m·ªôt Tr·ª£ l√Ω S∆∞ ph·∫°m Chuy√™n s√¢u v·ªÅ x√¢y d·ª±ng K·∫ø ho·∫°ch B√†i d·∫°y (Gi√°o √°n) theo chu·∫©n B·ªô Gi√°o d·ª•c v√† ƒê√†o t·∫°o, ƒë·∫∑c bi·ªát l√† c·∫•p Trung h·ªçc C∆° s·ªü (THCS).

[M·ª•c ti√™u] Nhi·ªám v·ª• c·ªßa b·∫°n l√† vi·∫øt, ki·ªÉm tra, v√† ho√†n thi·ªán K·∫ø ho·∫°ch B√†i d·∫°y (KHBD) cho gi√°o vi√™n THCS theo ƒë√∫ng y√™u c·∫ßu v·ªÅ n·ªôi dung v√† h√¨nh th·ª©c c·ªßa C√¥ng vƒÉn 5112/BGDƒêT-GDTrH ng√†y 01/12/2020, ƒë·∫£m b·∫£o t√≠nh khoa h·ªçc, s∆∞ ph·∫°m v√† ph√π h·ª£p v·ªõi th·ª±c ti·ªÖn.

[Nguy√™n t·∫Øc l√†m vi·ªác] Lu√¥n ƒë·∫∑t m·ª•c ti√™u ph√°t tri·ªÉn ph·∫©m ch·∫•t v√† nƒÉng l·ª±c h·ªçc sinh l√†m tr·ªçng t√¢m.

Ph·∫ßn 2: Y√™u c·∫ßu v·ªÅ N·ªôi dung v√† C·∫•u tr√∫c KHBD (Content and Structure Requirements)
[C·∫•u tr√∫c KHBD] K·∫ø ho·∫°ch B√†i d·∫°y b·∫°n t·∫°o ra ph·∫£i tu√¢n th·ªß c·∫•u tr√∫c c·ªßa m·ªôt KHBD ƒë·∫ßy ƒë·ªß theo y√™u c·∫ßu m·ªõi, bao g·ªìm c√°c th√†nh ph·∫ßn sau:
Lu√¥n s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng **LaTeX** ($a^2 + b^2 = c^2$) cho c√¥ng th·ª©c to√°n h·ªçc v√† khoa h·ªçc.
T√™n B√†i d·∫°y/Ch·ªß ƒë·ªÅ: (V√≠ d·ª•: B√†i 1. S·ªë h·ªØu t·ªâ - To√°n 7)

Th·ªùi l∆∞·ª£ng: (S·ªë ti·∫øt, ng√†y/bu·ªïi th·ª±c hi·ªán)

M·ª•c ti√™u B√†i h·ªçc: Ph√¢n chia r√µ r√†ng th√†nh:

Ki·∫øn th·ª©c: (H·ªçc sinh l√†m ƒë∆∞·ª£c g√¨ sau b√†i h·ªçc)

NƒÉng l·ª±c:

NƒÉng l·ª±c ƒë·∫∑c th√π: (V√≠ d·ª•: NƒÉng l·ª±c t√≠nh to√°n, nƒÉng l·ª±c ng√¥n ng·ªØ, nƒÉng l·ª±c gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ...)

NƒÉng l·ª±c chung: (T·ª± ch·ªß v√† t·ª± h·ªçc, Giao ti·∫øp v√† h·ª£p t√°c, Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v√† s√°ng t·∫°o)

Ph·∫©m ch·∫•t: (V√≠ d·ª•: ChƒÉm ch·ªâ, Trung th·ª±c, Tr√°ch nhi·ªám...)

Thi·∫øt b·ªã d·∫°y h·ªçc v√† H·ªçc li·ªáu: (Li·ªát k√™ chi ti·∫øt)

Ti·∫øn tr√¨nh D·∫°y h·ªçc: (Chia th√†nh c√°c ho·∫°t ƒë·ªông r√µ r√†ng)

Ho·∫°t ƒë·ªông 1: M·ªü ƒë·∫ßu/Kh·ªüi ƒë·ªông (X√°c ƒë·ªãnh v·∫•n ƒë·ªÅ/nhi·ªám v·ª• h·ªçc t·∫≠p, t·∫°o h·ª©ng th√∫)

Ho·∫°t ƒë·ªông 2: H√¨nh th√†nh Ki·∫øn th·ª©c m·ªõi/Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ (T·ªï ch·ª©c Hƒê c·ªßa GV v√† HS)

Ho·∫°t ƒë·ªông 3: Luy·ªán t·∫≠p/Th·ª±c h√†nh (C·ªßng c·ªë ki·∫øn th·ª©c, kƒ© nƒÉng)

Ho·∫°t ƒë·ªông 4: V·∫≠n d·ª•ng/T√¨m t√≤i m·ªü r·ªông (Giao nhi·ªám v·ª• v·ªÅ nh√†, li√™n h·ªá th·ª±c ti·ªÖn)

[Chi ti·∫øt Ti·∫øn tr√¨nh D·∫°y h·ªçc] Trong m·ª•c Ti·∫øn tr√¨nh D·∫°y h·ªçc, m·ªói Ho·∫°t ƒë·ªông ph·∫£i ƒë∆∞·ª£c tr√¨nh b√†y d∆∞·ªõi d·∫°ng m·ªôt b·∫£ng ho·∫∑c list v·ªõi ƒë·∫ßy ƒë·ªß c√°c c·ªôt/m·ª•c: M·ª•c ti√™u, N·ªôi dung (c√¥ng vi·ªác c·ª• th·ªÉ c·ªßa HS), S·∫£n ph·∫©m (d·ª± ki·∫øn), T·ªï ch·ª©c th·ª±c hi·ªán (chi ti·∫øt ho·∫°t ƒë·ªông c·ªßa GV v√† HS).

Ph·∫ßn 3: Quy tr√¨nh T∆∞∆°ng t√°c (Interaction Protocol)
Ch√†o h·ªèi & Thu th·∫≠p th√¥ng tin: Khi b·∫Øt ƒë·∫ßu, b·∫°n h√£y h·ªèi gi√°o vi√™n c√°c th√¥ng tin c·ªët l√µi sau:

M√¥n h·ªçc:

L·ªõp:

T√™n B√†i d·∫°y/Ch·ªß ƒë·ªÅ:

Th·ªùi l∆∞·ª£ng (s·ªë ti·∫øt):

X√¢y d·ª±ng KBD (L∆∞·ª£t 1): D·ª±a tr√™n th√¥ng tin ƒë√£ nh·∫≠n, b·∫°n h√£y ph√°c th·∫£o nhanh M·ª•c ti√™u B√†i h·ªçc v√† ƒë·ªÅ xu·∫•t Ti·∫øn tr√¨nh D·∫°y h·ªçc g·ªìm 4 Ho·∫°t ƒë·ªông c∆° b·∫£n.

Ph·∫£n h·ªìi & Tinh ch·ªânh (L∆∞·ª£t 2+): Sau khi gi√°o vi√™n cung c·∫•p th√™m th√¥ng tin chi ti·∫øt (v√≠ d·ª•: ph∆∞∆°ng ph√°p d·∫°y h·ªçc c·ª• th·ªÉ, t√†i nguy√™n s·ª≠ d·ª•ng, ho·∫∑c mu·ªën ƒëi·ªÅu ch·ªânh ho·∫°t ƒë·ªông n√†o ƒë√≥), b·∫°n ph·∫£i tinh ch·ªânh l·∫°i KBD ƒë·ªÉ ƒë·∫°t ƒë·ªô chi ti·∫øt cao nh·∫•t.

Ki·ªÉm tra C√¥ng vƒÉn 5112: Cu·ªëi c√πng, khi KBD ƒë√£ ho√†n th√†nh, h√£y ƒë∆∞a ra m·ªôt ƒë√°nh gi√° ng·∫Øn g·ªçn v·ªÅ vi·ªác KBD n√†y ƒë√£ ƒë√°p ·ª©ng ƒë·∫ßy ƒë·ªß c√°c y√™u c·∫ßu c∆° b·∫£n c·ªßa C√¥ng vƒÉn 5112 hay ch∆∞a (ƒë·∫∑c bi·ªát l√† vi·ªác chuy·ªÉn t·ª´ "Gi√°o √°n truy·ªÅn th·ªëng" sang "K·∫ø ho·∫°ch B√†i d·∫°y ph√°t tri·ªÉn nƒÉng l·ª±c").

Ph·∫ßn 4: L·ªùi Kh·∫≥ng ƒë·ªãnh (Affirmation)
H√£y nh·ªõ: M·ªçi KHBD ƒë·ªÅu ph·∫£i ƒë∆∞·ª£c tr√¨nh b√†y m·ªôt c√°ch s·∫°ch s·∫Ω, logic, d·ªÖ ƒë·ªçc v√† c√≥ th·ªÉ sao ch√©p tr·ª±c ti·∫øp ƒë·ªÉ s·ª≠ d·ª•ng. B·∫Øt ƒë·∫ßu b·∫±ng vi·ªác gi·ªõi thi·ªáu b·∫£n th√¢n v√† h·ªèi th√¥ng tin c·∫ßn thi·∫øt.`;
            // --- Helper Functions ---

            function showLoading(isLoading) {
                generateBtn.disabled = isLoading;
                if (isLoading) {
                    btnText.textContent = 'ƒêang T·∫°o...';
                    loadingSpinner.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    outputSection.classList.add('hidden');
                } else {
                    btnText.textContent = 'T·∫°o K·∫ø Ho·∫°ch B√†i D·∫°y';
                    loadingSpinner.classList.add('hidden');
                }
            }

            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                outputSection.classList.add('hidden');
            }

            // C·∫≠p nh·∫≠t h√†m generatePrompt ƒë·ªÉ nh·∫≠n th√™m tham s·ªë 'province'
            function generatePrompt(subject, grade, topic, duration, province) {
                return `H√£y so·∫°n th·∫£o K·∫ø ho·∫°ch B√†i D·∫°y (Gi√°o √°n) cho m√¥n ${subject}, c·∫•p h·ªçc ${grade}, v·ªõi ch·ªß ƒë·ªÅ/b√†i h·ªçc l√† "${topic}". Th·ªùi l∆∞·ª£ng d·ª± ki·∫øn l√† ${duration}. B√†i gi·∫£ng c·∫ßn t√≠ch h·ª£p n·ªôi dung gi√°o d·ª•c ƒë·ªãa ph∆∞∆°ng ph√π h·ª£p v·ªõi t·ªânh/th√†nh ph·ªë: ${province}. H√£y ƒë·∫£m b·∫£o k·∫ø ho·∫°ch chi ti·∫øt, c√≥ c√°c b∆∞·ªõc Kh·ªüi ƒë·ªông, H√¨nh th√†nh Ki·∫øn th·ª©c, Luy·ªán t·∫≠p, V·∫≠n d·ª•ng v√† th·ªÉ hi·ªán r√µ c√°c m·ª•c ti√™u v·ªÅ Ki·∫øn th·ª©c, NƒÉng l·ª±c, Ph·∫©m ch·∫•t.`;
            }

            function formatLessonPlan(plan) {
                let html = `<h3 class="text-xl md:text-2xl font-bold text-center text-blue-800 mb-8">${plan.tenBaiHoc.toUpperCase()}</h3>`;
                html += `<div class="space-y-6">`;
                
                // Th·ªùi l∆∞·ª£ng
                html += `<div class="p-4 bg-gray-50 rounded-lg">
                            <p class="font-semibold text-gray-700">‚è∞ Th·ªùi L∆∞·ª£ng:</p>
                            <p class="ml-4 text-lg text-gray-800">${plan.thoiLuong}</p>
                        </div>`;

                // M·ª•c Ti√™u
                html += `<div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <h4 class="text-xl font-bold text-blue-700 mb-2">I. M·ª§C TI√äU</h4>
                            <ul class="list-disc ml-6 space-y-2 text-gray-700">
                                <li><strong class="text-blue-600">Ki·∫øn Th·ª©c:</strong> ${plan.mucTieu.kienThuc}</li>
                                <li><strong class="text-blue-600">NƒÉng L·ª±c:</strong> ${plan.mucTieu.nangLuc}</li>
                                <li><strong class="text-blue-600">Ph·∫©m Ch·∫•t:</strong> ${plan.mucTieu.phamChat}</li>
                            </ul>
                        </div>`;

                // Chu·∫©n b·ªã
                html += `<div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                            <h4 class="text-xl font-bold text-green-700 mb-2">II. THI·∫æT B·ªä D·∫†Y H·ªåC V√Ä H·ªåC LI·ªÜU</h4>
                            <p class="ml-2 text-gray-700">${plan.thietBiDayHocVaHocLieu}</p>
                        </div>`;

                // Ti·∫øn Tr√¨nh D·∫°y H·ªçc
                html += `<div class="mt-8">
                            <h4 class="text-xl font-bold text-gray-800 mb-4">III. TI·∫æN TR√åNH D·∫†Y H·ªåC</h4>
                            <div class="space-y-6">`;

                plan.tienTrinhDayHoc.forEach((activity, index) => {
                    const stepNumber = index + 1;
                    html += `<div class="p-4 activity-card bg-white rounded-lg shadow-md hover:shadow-lg transition duration-200">
                                <p class="text-lg font-bold text-blue-600 mb-2">Ho·∫°t ƒë·ªông ${stepNumber}: ${activity.tenHoatDong}</p>
                                <div class="space-y-1 text-sm text-gray-700 ml-2">
                                    <p><strong>üïí Th·ªùi gian:</strong> ${activity.thoiGian}</p>
                                    <p><strong>üìù N·ªôi dung & C√°ch th·ª©c:</strong> ${activity.noiDungVaCachThuc}</p>
                                    <p><strong>‚úÖ S·∫£n ph·∫©m d·ª± ki·∫øn:</strong> ${activity.sanPham}</p>
                                </div>
                            </div>`;
                });

                html += `       </div>
                            </div>`;

                // ƒê√°nh Gi√°
                html += `<div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400 mt-8">
                            <h4 class="text-xl font-bold text-yellow-700 mb-2">IV. ƒê√ÅNH GI√Å (Ki·ªÉm tra, ƒê√°nh gi√° t·ªïng th·ªÉ)</h4>
                            <p class="ml-2 text-gray-700">${plan.danhGia}</p>
                        </div>`;


                html += `</div>`; // End space-y-6
                return html;
            }

            // --- Main Generation Function ---

            window.generateLessonPlan = async function() {
                // Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa kh√≥a API
                if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || !apiKey) {
                    showError("L·ªói: Kh√≥a API ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p. Vui l√≤ng d√°n kh√≥a API Gemini c·ªßa b·∫°n v√†o bi·∫øn 'apiKey' trong m√£ ngu·ªìn.");
                    return;
                }

                const subject = document.getElementById('subject').value.trim();
                const grade = document.getElementById('grade').value.trim();
                const topic = document.getElementById('topic').value.trim();
                const province = document.getElementById('province').value.trim(); // L·∫•y gi√° tr·ªã T·ªânh/Th√†nh ph·ªë
                const duration = document.getElementById('duration').value.trim();

                // C·∫≠p nh·∫≠t ƒëi·ªÅu ki·ªán ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
                if (!subject || !grade || !topic || !duration || !province) { 
                    showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin (M√¥n h·ªçc, Kh·ªëi/C·∫•p, Ch·ªß ƒë·ªÅ, T·ªânh/Th√†nh ph·ªë, Th·ªùi l∆∞·ª£ng).");
                    return;
                }

                showLoading(true);
                lessonPlanOutput.innerHTML = '';
                
                // Truy·ªÅn province v√†o h√†m generatePrompt
                const userQuery = generatePrompt(subject, grade, topic, duration, province);

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: SYSTEM_INSTRUCTION }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: LESSON_PLAN_SCHEMA
                    }
                };
                
                let attempt = 0;
                const maxRetries = 3;

                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // C·ªë g·∫Øng ƒë·ªçc th√¥ng b√°o l·ªói t·ª´ API
                            const errorData = await response.json();
                            let errorMessageDetail = `L·ªói HTTP: ${response.status}. `;
                            if (errorData.error && errorData.error.message) {
                                errorMessageDetail += `Chi ti·∫øt: ${errorData.error.message}`;
                            } else {
                                errorMessageDetail += "Vui l√≤ng ki·ªÉm tra kh√≥a API v√† gi·ªõi h·∫°n s·ª≠ d·ª•ng.";
                            }
                            throw new Error(errorMessageDetail);
                        }

                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (!jsonText) {
                            throw new Error("Ph·∫£n h·ªìi t·ª´ AI r·ªóng ho·∫∑c kh√¥ng c√≥ c·∫•u tr√∫c JSON.");
                        }

                        const lessonPlanData = JSON.parse(jsonText);
                        
                        // Render the structured plan
                        lessonPlanOutput.innerHTML = formatLessonPlan(lessonPlanData);
                        outputSection.classList.remove('hidden');
                        showLoading(false);
                        return;

                    } catch (error) {
                        console.error("L·ªói trong qu√° tr√¨nh t·∫°o gi√°o √°n:", error);
                        attempt++;
                        if (attempt < maxRetries) {
                            // Exponential backoff
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            showError(`ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng ho·∫∑c m·∫°ng sau ${maxRetries} l·∫ßn th·ª≠. Chi ti·∫øt: ${error.message}`);
                            showLoading(false);
                            return;
                        }
                    }
                }
            }
        </script>
    </div>
</body>
</html>
